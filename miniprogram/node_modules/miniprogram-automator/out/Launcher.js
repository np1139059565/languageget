"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=__importDefault(require("path")),Connection_1=__importDefault(require("./Connection")),MiniProgram_1=__importDefault(require("./MiniProgram")),child_process_1=__importDefault(require("child_process")),isEmpty_1=__importDefault(require("licia/isEmpty")),extendDeep_1=__importDefault(require("licia/extendDeep")),getPort_1=__importDefault(require("licia/getPort")),toStr_1=__importDefault(require("licia/toStr")),isWindows_1=__importDefault(require("licia/isWindows")),fs_1=__importDefault(require("licia/fs")),waitUntil_1=__importDefault(require("licia/waitUntil")),concat_1=__importDefault(require("licia/concat")),sleep_1=__importDefault(require("licia/sleep")),endWith_1=__importDefault(require("licia/endWith")),isRelative_1=__importDefault(require("licia/isRelative"));class Launcher{async launch(t){const{cliPath:e=await this.resolveCliPath(),timeout:i=3e4,projectConfig:r={},cwd:a="",account:o=""}=t;let{args:l=[]}=t,{projectPath:n}=t;const c=await getPort_1.default(t.port||9420);if(t.port&&t.port!==c)throw Error(`Port ${t.port} is in use, please specify another port`);if(!e)throw Error("Wechat web devTools not found, please specify cliPath option");if(isWindows_1.default&&endWith_1.default(e,".exe"))throw Error("cliPath is not correct, it's usually named as 'cli' or 'cli.bat'");if(!n)throw Error("projectPath is not provided");if(isRelative_1.default(n)&&(n=path_1.default.resolve(n)),!await fs_1.default.exists(n))throw Error(`Project path ${n} doesn't exist`);isEmpty_1.default(r)||await this.extendProjectConfig(r,n);const s={stdio:"ignore"};a&&(s.cwd=a);let u=null,_=!1;l=concat_1.default(l,["--auto",n,"--auto-port",toStr_1.default(c)]),o&&(l=concat_1.default(l,["--auto-account",o]));try{const t=child_process_1.default.spawn(e,l,s);t.on("error",t=>{u=t}),t.on("exit",()=>{setTimeout(()=>{_=!0},15e3)})}catch(t){u=t}let p=null;if(await waitUntil_1.default(async()=>{try{return!(!u&&!_)||(p=await this.connectTool({wsEndpoint:`ws://127.0.0.1:${c}`}),!0)}catch(t){return!1}},i,1e3),p)await p.checkVersion();else{if(u)throw Error("Failed to launch wechat web devTools, please make sure cliPath is correctly specified");if(_)throw Error("Failed to launch wechat web devTools, please make sure http port is open")}return await sleep_1.default(5e3),p}async connect(t){const e=await this.connectTool(t);return await e.checkVersion(),e}async extendProjectConfig(t,e){const i=path_1.default.resolve(e,"project.config.json"),r=JSON.parse(await fs_1.default.readFile(i,"utf8"));extendDeep_1.default(r,t),await fs_1.default.writeFile(i,JSON.stringify(r,null,2),"utf8")}async connectTool(t){let e;try{const i=await Connection_1.default.create(t.wsEndpoint);e=new MiniProgram_1.default(i)}catch(e){throw Error(`Failed connecting to ${t.wsEndpoint}, check if target project window is opened with automation enabled`)}return e}async resolveCliPath(){let t="";return t=isWindows_1.default?"C:/Program Files (x86)/Tencent/微信web开发者工具/cli.bat":"/Applications/wechatwebdevtools.app/Contents/MacOS/cli",await fs_1.default.exists(t)?t:""}}exports.default=Launcher;